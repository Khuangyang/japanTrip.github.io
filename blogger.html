<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Khuang Yang Blogger</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="icon" href="data:,">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  
  <style>
  .carousel-item {
    min-height: 280px;
  }
  .carousel img {
    height: 400px;
    width: 100%;
    object-fit: cover;
    object-position: center;
  }
  
  .card img {
    height: 200px;
    width: 100%;
    object-fit: cover;
    object-position: center;
    padding: 6px;
  }
  
  .map-container {
    min-height: 400px;
    margin-bottom: 30px;
    position: relative;
  }
  
  #map {
    height: 500px;
    width: 100%;
    border-radius: 8px;
  }
  
  .info-window-content {
    padding: 10px;
  }
  
  .info-window-content h5 {
    margin: 0 0 10px 0;
    color: #333;
  }
  
  .info-window-content p {
    margin: 5px 0;
    font-size: 14px;
  }
  
  @media (max-width: 768px) {
    .carousel img {
      height: 250px;
    }
    #map {
      height: 400px;
    }
  }
  </style>
</head>
<body>
  <div class="m-4">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a href="#" class="navbar-brand">
          <i class="bi bi-snow"></i>
        </a>
        <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <div class="navbar-nav">
            <a href="#" class="nav-item nav-link active">Home</a>
            <a href="#" class="nav-item nav-link">Shops</a>
            <a href="#" class="nav-item nav-link">Foods</a>
            <a href="#" class="nav-item nav-link disabled" tabindex="-1">Attractions</a>
          </div>
        </div>
      </div>
    </nav>
  </div>

  <div class="container-lg my-3">
    <!-- Carousel -->
    <div id="myCarousel" class="carousel slide" data-bs-ride="carousel">
      <ol class="carousel-indicators">
        <li data-bs-target="#myCarousel" data-bs-slide-to="0" class="active"></li>
        <li data-bs-target="#myCarousel" data-bs-slide-to="1"></li>
        <li data-bs-target="#myCarousel" data-bs-slide-to="2"></li>
      </ol>
      
      <div class="carousel-inner">
        <div class="carousel-item active">
          <img src="https://t4.ftcdn.net/jpg/02/31/80/55/360_F_231805528_rcZO6OJHBf8oiYQdqfQd4qQLY4GCR2q9.jpg" alt="Slide 1">
        </div>
        <div class="carousel-item">
          <img src="https://cdn.shopify.com/s/files/1/1083/2612/files/fuji5_480x480.jpg?v=1730864941" alt="Slide 2">
        </div>
        <div class="carousel-item">
          <img src="https://cdn.twocontinents.com/cdn-cgi/image/width=3840/https://cdn.twocontinents.com/all_trails_to_mount_fuji_will_be_charged_b0ac8bf5c1.jpg" alt="Slide 3">
        </div>
      </div>

      <a class="carousel-control-prev" href="#myCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </a>
      <a class="carousel-control-next" href="#myCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </a>
    </div>

    <!-- Cards -->
    <div class="card-group my-3">
      <div class="card">
        <img src="https://images.squarespace-cdn.com/content/v1/5bbcf00a9b8fe874ed2f03d0/8df16572-514b-4c98-9d42-803e20cb199d/hie-shrine-tokyo.jpg?format=1000w" class="card-img-top" alt="Hie Shrine">
        <div class="card-body">
          <h5 class="card-title">Hie Shrine</h5>
        </div>
      </div>
      <div class="card">
        <img src="https://images.squarespace-cdn.com/content/v1/5bbcf00a9b8fe874ed2f03d0/2cda718b-d915-452b-a69b-df63de7baa7b/imperial-palace-tokyo.jpg?format=2500w" class="card-img-top" alt="Imperial Palace">
        <div class="card-body">
          <h5 class="card-title">Imperial Palace and Gardens</h5>
        </div>
      </div>
      <div class="card">
        <img src="https://images.squarespace-cdn.com/content/v1/5bbcf00a9b8fe874ed2f03d0/02f0abf1-6ac0-4870-89a0-e9b5eb40d071/shinjuku-Gyoen-park.jpg?format=2500w" class="card-img-top" alt="Shinjuku Garden">
        <div class="card-body">
          <h5 class="card-title">Shinjuku Gyoen National Garden</h5>
        </div>
      </div>
    </div>

    <!-- Interactive Google Map -->
    <div class="map-container">
      <div id="map"></div>
    </div>

    <!-- Table -->
    <div class="m-3">
      <table id="add_table" class="table" data-toggle="table" data-mobile-responsive="true">
        <thead>
          <tr>
            <th>Place</th>
            <th>Location</th>
            <th>Category</th>
            <th>Rating</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <input type="text" class="form-control place">
            </td>
            <td>
              <input type="text" class="form-control location">
            </td>
            <td>
              <input type="text" class="form-control category">
            </td>
            <td>
              <input type="number" class="form-control rating">
            </td>
            <td>
              <button class="btn btn-outline-success addRowBtn">add</button>
            </td>
            <td>
              <button class="btn btn-outline-danger delete_row">remove</button>
            </td>      
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    /* ========================================
       PART 1: GLOBAL VARIABLES
       These variables can be used anywhere in the code
       ======================================== */
    
    let map;           // Stores the Google Map object
    let infoWindow;    // Stores the popup window that shows place details
    let markers = [];  // Array to keep track of all map markers (pins)

    /* ========================================
       PART 2: INITIALIZE THE MAP
       This function runs when the page loads
       ======================================== */
    
    async function initMap() {
      // Step 1: Load Google Maps libraries
      // These are like toolboxes with different tools we need
      const { Map, InfoWindow } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
      const { Place } = await google.maps.importLibrary("places");

      // Step 2: Set the center point of the map Resol poshtel (Tokyo)
      const center = { lat: 35.71366141275859, lng: 139.79131272698618 };
      
      // Step 3: Create the map and display it in the element with id="map"
      map = new Map(document.getElementById("map"), {
        zoom: 10,                    // How zoomed in the map is (1=world, 20=street)
        center: center,              // Where the map centers
        mapId: "DEMO_MAP_ID",        // Required for Advanced Markers
      });

      // Step 4: Create an info window (the popup that appears when you click markers)
      infoWindow = new InfoWindow();

      // Step 5: Search for places near Mount Fuji when page loads
      // Parameters: (location, radius in meters, should we clear old markers?)
      await searchNearbyPlaces(center, 50000, true);
      await searchNearbyPlaces({lat: 35.50525411957015, lng: 138.7600462957958}, 20000);  // Tokoko Inn (Fujikawa)
      await searchNearbyPlaces({lat: 35.23976736201863, lng: 139.0720150882234}, 20000);  // Hot Spring Inn Hakone (Hakone)
      await searchNearbyPlaces({lat: 35.69725760840773, lng: 139.70271239316762}, 20000);  // Hotel Livemax Shinjuku (Toyko)

      // Step 6: Add a click listener - when user clicks the map, search that area
      map.addListener('click', async (event) => {
        console.log('Map clicked at:', event.latLng.lat(), event.latLng.lng());
        // Search within 10km of where they clicked, DON'T clear existing markers
        await searchNearbyPlaces(event.latLng, 10000, false);
      });
    }

    /* ========================================
       PART 3: CLEAR MARKERS FROM MAP
       Removes all pins from the map
       ======================================== */
    
    function clearMarkers() {
      // Loop through each marker in our markers array
      markers.forEach(marker => {
        marker.map = null;  // Setting map to null removes the marker from display
      });
      markers = [];  // Empty the array
    }

    /* ========================================
       PART 4: SEARCH FOR NEARBY PLACES
       This asks Google to find places near a location
       ======================================== */
    
    async function searchNearbyPlaces(location, radius = 50000, clearOldMarkers = false) {
      try {
        // Load the places library
        const { places } = await google.maps.importLibrary("places");
        
        // Log to console so we can see what's happening (press F12 to see console)
        console.log(`Searching at lat: ${location.lat}, lng: ${location.lng}, radius: ${radius}m`);
        
        // Create a search request object
        const request = {
          // What information we want about each place
          fields: ['displayName', 'location', 'types', 'rating', 'userRatingCount'],
          
          // Where to search
          locationRestriction: {
            center: location,    // Center point
            radius: radius,      // How far from center (in meters)
          },
          
          // What types of places to find
          includedTypes: [
            'tourist_attraction',      // Main landmarks
            'historical_landmark',     // Historical sites
            'park',                    // Parks & gardens
            'amusement_park',          // Theme parks
            'spa',                     // Hot springs (onsen)
            'market',                  // Traditional markets
            'shopping_mall',           // Shopping areas
          ],
          
          // Maximum number of results
          maxResultCount: 20,
        };

        // Send the request to Google and wait for results
        const { places: results } = await google.maps.places.Place.searchNearby(request);
        
        // Should we clear old markers? (Only true on initial page load)
        if (clearOldMarkers) {
          clearMarkers();
        }
        
        // Check if we found any places
        if (results && results.length > 0) {
          console.log(`Found ${results.length} places`);
          
          // For each place we found, create a marker on the map
          for (const place of results) {
            await createMarker(place);
          }
          
          // If this was a small search (user clicked map), show details of first result
          if (radius < 10000 && results[0]) {
            showPlaceDetails(results[0]);
          }
        } else {
          // No places found
          console.log('No places found in this area');
          alert(`No places found within ${radius}m of this location. Try clicking in a different area.`);
        }
      } catch (error) {
        // If something goes wrong, log it and show an alert
        console.error('Error searching places:', error);
        alert('Error searching for places: ' + error.message);
      }
    }

    /* ========================================
       PART 5: CREATE A MARKER (PIN) ON THE MAP
       Puts a pin on the map for each place
       ======================================== */
    
    async function createMarker(place) {
      // If the place doesn't have a location, skip it
      if (!place.location) return;

      // Load the marker library
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

      // Create a new marker
      const marker = new AdvancedMarkerElement({
        map: map,                      // Which map to put it on
        position: place.location,      // Where to put it (lat/lng coordinates)
        title: place.displayName,      // Text shown when hovering over marker
      });

      // Add this marker to our tracking array
      markers.push(marker);

      // Add a click listener - when user clicks the marker, show details
      marker.addListener('click', () => {
        showPlaceDetails(place);
      });
    }

    /* ========================================
       PART 6: SHOW PLACE DETAILS IN POPUP
       When user clicks a marker, show info about that place
       ======================================== */
    
    async function showPlaceDetails(place) {
      try {
        // Request more detailed information about this place
        await place.fetchFields({
          fields: ['displayName', 'formattedAddress', 'rating', 'userRatingCount', 
                   'types', 'regularOpeningHours', 'websiteURI', 'location']
        });

        // Build HTML content for the info window
        let content = '<div class="info-window-content">';
        
        // Add place name
        content += `<h5>${place.displayName || 'Unknown Place'}</h5>`;
        
        // Add rating if available
        if (place.rating) {
          content += `<p><strong>Rating:</strong> ${place.rating} ‚≠ê (${place.userRatingCount || 0} reviews)</p>`;
        }
        
        // Add address if available
        if (place.formattedAddress) {
          content += `<p><strong>Address:</strong> ${place.formattedAddress}</p>`;
        }
        
        // Add category if available
        if (place.types && place.types.length > 0) {
          const category = place.types[0].replace(/_/g, ' ');
          content += `<p><strong>Category:</strong> ${category}</p>`;
        }
        
        // Add open/closed status if available
        if (place.regularOpeningHours) {
          const isOpen = place.regularOpeningHours.isOpen ? place.regularOpeningHours.isOpen() : null;
          if (isOpen !== null) {
            content += `<p><strong>Status:</strong> ${isOpen ? 'üü¢ Open' : 'üî¥ Closed'}</p>`;
          }
        }
        
        // Add website link if available
        if (place.websiteURI) {
          content += `<p><a href="${place.websiteURI}" target="_blank">Visit Website</a></p>`;
        }

        // Add geo if available
        if (place.location) {
          content += `<p><a href="${place.location}" target="_blank">geo</a></p>`;
        }
        
        // Prepare data for the "Add to Table" button
        // We need to escape special characters so they don't break the HTML
        const safeName = (place.displayName || 'Unknown Place')
          .replace(/'/g, "\\'")      // Replace single quotes
          .replace(/"/g, '&quot;');   // Replace double quotes
        
        const safeAddress = (place.formattedAddress || 'No address available')
          .replace(/'/g, "\\'")
          .replace(/"/g, '&quot;');
        
        const safeCategory = place.types && place.types.length > 0 
          ? place.types[0].replace(/_/g, ' ') 
          : 'Unknown';
        
        const safeRating = place.rating || '';
        
        // Add button to add this place to the table
        content += `<button class="btn btn-sm btn-primary mt-2" onclick="addToTable('${safeName}', '${safeAddress}', '${safeCategory}', '${safeRating}')">Add to Table</button>`;
        content += '</div>';

        // Display the info window at the place's location
        infoWindow.setContent(content);
        infoWindow.setPosition(place.location);
        infoWindow.open(map);
      } catch (error) {
        console.error('Error fetching place details:', error);
      }
    }

    /* ========================================
       PART 7: ADD PLACE TO TABLE
       Called when user clicks "Add to Table" in the info window
       ======================================== */
    
    function addToTable(name, address, category, rating) {
      // Validate we have required information
      if (!name || name === 'Unknown Place' || !address || address === 'No address available') {
        alert("Please fill in at least Place and Location fields.");
        return;
      }
      
      // Find the input row (the last row with input fields)
      const $row = $('.addRowBtn').closest('tr');
      
      // Create a new table row with the place information
      var newRow = '<tr>' +
          '<td class="place">' + name + '</td>' +
          '<td class="location">' + address + '</td>' +
          '<td class="category">' + category + '</td>' +
          '<td class="rating">' + rating + '</td>' +
          '<td><button class="btn btn-outline-success addRowBtn">add</button></td>' +
          '<td><button class="btn btn-outline-danger delete_row">remove</button></td>' +
          '</tr>';
      
      // Add the new row before the input row
      $row.before(newRow);
      
      // Close the info window
      if (infoWindow) {
        infoWindow.close();
      }
    }

    /* ========================================
       PART 8: WAIT FOR PAGE TO LOAD, THEN INITIALIZE MAP
       ======================================== */
    
    window.addEventListener('load', () => {
      initMap();
    });

    /* ========================================
       PART 9: TABLE FUNCTIONALITY (jQuery)
       Handles adding and removing rows in the table
       ======================================== */
    
    $(document).ready(function () {
      // Your Google Apps Script URL
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxkuo4NVsZ7Q_Iw975qy8Cl9aYtb7LPOTwTZhLOfOLqEtt6PY-QKvrik61ORRHw36Xyyw/exec';
      
      // CLICK HANDLER FOR "ADD" BUTTON
      $(document).on("click", ".addRowBtn", function () {
        const $row = $(this).closest('tr');
        
        // Find input fields in this row
        const $placeInput = $row.find('input.place');
        const $locationInput = $row.find('input.location');
        const $categoryInput = $row.find('input.category');
        const $ratingInput = $row.find('input.rating');
        
        let place, location, category, rating;
        
        // Check if this row has input fields or just text
        if ($placeInput.length > 0) {
          // This is the input row (bottom row with text boxes)
          place = $placeInput.val();
          location = $locationInput.val();
          category = $categoryInput.val();
          rating = $ratingInput.val();
        } else {
          // This is a text row (added from map)
          place = $row.find('td.place').text();
          location = $row.find('td.location').text();
          category = $row.find('td.category').text();
          rating = $row.find('td.rating').text();
        }

        // Validate we have place and location
        if (place !== "" && location !== "") {
          // Create URL parameters
          const params = new URLSearchParams({
              action: "add",
              place: place,
              location: location,
              category: category,
              rating: rating
          });
          
          // Send data to Google Sheets
          fetch(WEB_APP_URL + '?' + params.toString(), {
              method: 'GET',
              mode: 'no-cors'  // Required for Google Apps Script
          })
          .then(() => {
              console.log("Data sent to Google Sheets");
              
              // If this was from the input row
              if ($placeInput.length > 0) {
                // Create a new display row
                var newRow = '<tr>' +
                    '<td>' + place + '</td>' +
                    '<td>' + location + '</td>' +
                    '<td>' + category + '</td>' +
                    '<td>' + rating + '</td>' +
                    '<td><button class="btn btn-outline-danger delete_row">remove</button></td>' +
                    '</tr>';
                
                // Add it before the input row
                $row.before(newRow);
                // Clear the input fields
                $row.find('input').val('');
              } else {
                // If this was from a map-added row, remove the add button
                $(this).remove();
              }
          })
          .catch(error => {
              console.error("Error:", error);
          });
        } else {
            alert("Please fill in at least Place and Location fields.");
        }
      });

      // CLICK HANDLER FOR "REMOVE" BUTTON
      $(document).on('click', '.delete_row', function() {
        // Remove the entire row
        $(this).closest('tr').remove();
      });
    });
  </script>

  <!-- Google Maps API Loader -->
  <script>
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.googleapis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
      key: "AIzaSyDCcPel8TpdWZrbZj9IYP5_UOZLc5gPyGU",
      v: "weekly",
    });
  </script>

</body>
</html>
