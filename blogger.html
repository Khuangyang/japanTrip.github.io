<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Khuang Yang Blogger</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="icon" href="data:,">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  
  <style>
  .carousel-item {
    min-height: 280px;
  }
  .carousel img {
    height: 400px;
    width: 100%;
    object-fit: cover;
    object-position: center;
  }
  
  .card img {
    height: 200px;
    width: 100%;
    object-fit: cover;
    object-position: center;
    padding: 6px;
  }
  
  .map-container {
    min-height: 400px;
    margin-bottom: 30px;
    position: relative;
  }
  
  #map {
    height: 500px;
    width: 100%;
    border-radius: 8px;
  }
  
  .info-window-content {
    padding: 10px;
  }
  
  .info-window-content h5 {
    margin: 0 0 10px 0;
    color: #333;
  }
  
  .info-window-content p {
    margin: 5px 0;
    font-size: 14px;
  }
  
  @media (max-width: 768px) {
    .carousel img {
      height: 250px;
    }
    #map {
      height: 400px;
    }
  }
  </style>
</head>
<body>
  <div class="m-4">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a href="#" class="navbar-brand">
          <i class="bi bi-snow"></i>
        </a>
        <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <div class="navbar-nav">
            <a href="#" class="nav-item nav-link active">Home</a>
            <a href="#" class="nav-item nav-link">Shops</a>
            <a href="#" class="nav-item nav-link">Foods</a>
            <a href="#" class="nav-item nav-link disabled" tabindex="-1">Attractions</a>
          </div>
        </div>
      </div>
    </nav>
  </div>

  <div class="container-lg my-3">
    <!-- Carousel -->
    <div id="myCarousel" class="carousel slide" data-bs-ride="carousel">
      <ol class="carousel-indicators">
        <li data-bs-target="#myCarousel" data-bs-slide-to="0" class="active"></li>
        <li data-bs-target="#myCarousel" data-bs-slide-to="1"></li>
        <li data-bs-target="#myCarousel" data-bs-slide-to="2"></li>
      </ol>
      
      <div class="carousel-inner">
        <div class="carousel-item active">
          <img src="https://t4.ftcdn.net/jpg/02/31/80/55/360_F_231805528_rcZO6OJHBf8oiYQdqfQd4qQLY4GCR2q9.jpg" alt="Slide 1">
        </div>
        <div class="carousel-item">
          <img src="https://cdn.shopify.com/s/files/1/1083/2612/files/fuji5_480x480.jpg?v=1730864941" alt="Slide 2">
        </div>
        <div class="carousel-item">
          <img src="https://cdn.twocontinents.com/cdn-cgi/image/width=3840/https://cdn.twocontinents.com/all_trails_to_mount_fuji_will_be_charged_b0ac8bf5c1.jpg" alt="Slide 3">
        </div>
      </div>

      <a class="carousel-control-prev" href="#myCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </a>
      <a class="carousel-control-next" href="#myCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </a>
    </div>

    <!-- Cards -->
    <div class="card-group my-3">
      <div class="card">
        <img src="https://images.squarespace-cdn.com/content/v1/5bbcf00a9b8fe874ed2f03d0/8df16572-514b-4c98-9d42-803e20cb199d/hie-shrine-tokyo.jpg?format=1000w" class="card-img-top" alt="Hie Shrine">
        <div class="card-body">
          <h5 class="card-title">Hie Shrine</h5>
        </div>
      </div>
      <div class="card">
        <img src="https://images.squarespace-cdn.com/content/v1/5bbcf00a9b8fe874ed2f03d0/2cda718b-d915-452b-a69b-df63de7baa7b/imperial-palace-tokyo.jpg?format=2500w" class="card-img-top" alt="Imperial Palace">
        <div class="card-body">
          <h5 class="card-title">Imperial Palace and Gardens</h5>
        </div>
      </div>
      <div class="card">
        <img src="https://images.squarespace-cdn.com/content/v1/5bbcf00a9b8fe874ed2f03d0/02f0abf1-6ac0-4870-89a0-e9b5eb40d071/shinjuku-Gyoen-park.jpg?format=2500w" class="card-img-top" alt="Shinjuku Garden">
        <div class="card-body">
          <h5 class="card-title">Shinjuku Gyoen National Garden</h5>
        </div>
      </div>
    </div>

    <!-- Interactive Google Map -->
    <div class="map-container">
      <div id="map"></div>
    </div>

    <!-- Table -->
    <div class="m-3">
      <table id="add_table" class="table" data-toggle="table" data-mobile-responsive="true">
        <thead>
          <tr>
            <th>Place</th>
            <th>Location</th>
            <th>Category</th>
            <th>Rating</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <input type="text" class="form-control place">
            </td>
            <td>
              <input type="text" class="form-control location">
            </td>
            <td>
              <input type="text" class="form-control category">
            </td>
            <td>
              <input type="number" class="form-control rating">
            </td>
            <td>
              <button class="btn btn-outline-success addRowBtn">add</button>
            </td>
            <td>
              <button class="btn btn-outline-danger delete_row">remove</button>
            </td>      
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Initialize the map using new Google Maps API
    let map;
    let infoWindow;

    async function initMap() {
      // Load required libraries
      const { Map, InfoWindow } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
      const { Place } = await google.maps.importLibrary("places");

      // Center on Mount Fuji area
      const center = { lat: 35.3606, lng: 138.7274 };
      
      map = new Map(document.getElementById("map"), {
        zoom: 10,
        center: center,
        mapId: "DEMO_MAP_ID", // Required for Advanced Markers
      });

      infoWindow = new InfoWindow();

      // Search for nearby places using the new API
      await searchNearbyPlaces(center);

      // Add click listener to the map
      map.addListener('click', async (event) => {
        await searchNearbyPlaces(event.latLng, 500);
      });
    }

    async function searchNearbyPlaces(location, radius = 50000) {
      try {
        const { places } = await google.maps.importLibrary("places");
        
        const request = {
          fields: ['displayName', 'location', 'types', 'rating', 'userRatingCount'],
          locationRestriction: {
            center: location,
            radius: radius,
          },
          includedTypes: ['tourist_attraction', 'park', 'museum'],
          maxResultCount: 20,
        };

        const { places: results } = await google.maps.places.Place.searchNearby(request);
        
        if (results && results.length > 0) {
          results.forEach(place => {
            createMarker(place);
          });
          
          // If it's a small radius search, show details of first result
          if (radius < 1000 && results[0]) {
            showPlaceDetails(results[0]);
          }
        }
      } catch (error) {
        console.error('Error searching places:', error);
      }
    }

    async function createMarker(place) {
      if (!place.location) return;

      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

      const marker = new AdvancedMarkerElement({
        map: map,
        position: place.location,
        title: place.displayName,
      });

      marker.addListener('click', () => {
        showPlaceDetails(place);
      });
    }

    async function showPlaceDetails(place) {
      try {
        // Fetch full details
        await place.fetchFields({
          fields: ['displayName', 'formattedAddress', 'rating', 'userRatingCount', 'types', 'regularOpeningHours', 'websiteURI']
        });
    
        let content = '<div class="info-window-content">';
        content += `<h5>${place.displayName || 'Unknown Place'}</h5>`;
        
        if (place.rating) {
          content += `<p><strong>Rating:</strong> ${place.rating} ‚≠ê (${place.userRatingCount || 0} reviews)</p>`;
        }
        
        if (place.formattedAddress) {
          content += `<p><strong>Address:</strong> ${place.formattedAddress}</p>`;
        }
        
        if (place.types && place.types.length > 0) {
          const category = place.types[0].replace(/_/g, ' ');
          content += `<p><strong>Category:</strong> ${category}</p>`;
        }
        
        if (place.regularOpeningHours) {
          const isOpen = place.regularOpeningHours.isOpen ? place.regularOpeningHours.isOpen() : null;
          if (isOpen !== null) {
            content += `<p><strong>Status:</strong> ${isOpen ? 'üü¢ Open' : 'üî¥ Closed'}</p>`;
          }
        }
        
        if (place.websiteURI) {
          content += `<p><a href="${place.websiteURI}" target="_blank">Visit Website</a></p>`;
        }
        
        // Ensure all values have defaults and are properly escaped
        const safeName = (place.displayName || 'Unknown Place').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const safeAddress = (place.formattedAddress || 'No address available').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const safeCategory = place.types && place.types.length > 0 ? place.types[0].replace(/_/g, ' ') : 'Unknown';
        const safeRating = place.rating || '';
        
        content += `<button class="btn btn-sm btn-primary mt-2" onclick="addToTable('${safeName}', '${safeAddress}', '${safeCategory}', '${safeRating}')">Add to Table</button>`;
        content += '</div>';
    
        infoWindow.setContent(content);
        infoWindow.setPosition(place.location);
        infoWindow.open(map);
      } catch (error) {
        console.error('Error fetching place details:', error);
      }
    }

    // Function to add place info to table
    function addToTable(name, address, category, rating) {
      // Validate that we have at least name and address
      if (!name || name === 'Unknown Place' || !address || address === 'No address available') {
        alert("Please fill in at least Place and Location fields.");
        return;
      }
      
      const $row = $('.addRowBtn').closest('tr');
      
      var newRow = '<tr>' +
          '<td class="place">' + name + '</td>' +
          '<td class="location">' + address + '</td>' +
          '<td class="category">' + category + '</td>' +
          '<td class="rating">' + rating + '</td>' +
          '<td><button class="btn btn-outline-success addRowBtn">add</button></td>' +
          '<td><button class="btn btn-outline-danger delete_row">remove</button></td>' +
          '</tr>';
      
      $row.before(newRow);
      
      // Close the info window
      if (infoWindow) {
        infoWindow.close();
      }
    }

    // Wait for Google Maps to load before initializing
    window.addEventListener('load', () => {
      initMap();
    });

    // Table functionality
    $(document).ready(function () {
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxkuo4NVsZ7Q_Iw975qy8Cl9aYtb7LPOTwTZhLOfOLqEtt6PY-QKvrik61ORRHw36Xyyw/exec';
      
      $(document).on("click", ".addRowBtn", function () {
        const $row = $(this).closest('tr');
        
        // Check if this row has inputs or just text
        const $placeInput = $row.find('input.place');
        const $locationInput = $row.find('input.location');
        const $categoryInput = $row.find('input.category');
        const $ratingInput = $row.find('input.rating');
        
        let place, location, category, rating;
        
        if ($placeInput.length > 0) {
          // This is an input row (the bottom row)
          place = $placeInput.val();
          location = $locationInput.val();
          category = $categoryInput.val();
          rating = $ratingInput.val();
        } else {
          // This is a text row (added from map)
          place = $row.find('td.place').text();
          location = $row.find('td.location').text();
          category = $row.find('td.category').text();
          rating = $row.find('td.rating').text();
        }

        if (place !== "" && location !== "") {
          // Use fetch with GET method and query parameters (works with Google Apps Script)
          const params = new URLSearchParams({
              action: "add",
              place: place,
              location: location,
              category: category,
              rating: rating
          });
          
          fetch(WEB_APP_URL + '?' + params.toString(), {
              method: 'GET',
              mode: 'no-cors' // This bypasses CORS but won't return response
          })
          .then(() => {
              console.log("Data sent to Google Sheets");
              
              // If this was from an input row, create a new display row and clear inputs
              if ($placeInput.length > 0) {
                var newRow = '<tr>' +
                    '<td>' + place + '</td>' +
                    '<td>' + location + '</td>' +
                    '<td>' + category + '</td>' +
                    '<td>' + rating + '</td>' +
                    '<td><button class="btn btn-outline-danger delete_row">remove</button></td>' +
                    '</tr>';
                
                $row.before(newRow);
                $row.find('input').val('');
              } else {
                // If this was from a map-added row, just remove the add button
                $(this).remove();
              }
          })
          .catch(error => {
              console.error("Error:", error);
          });
        } else {
            alert("Please fill in at least Place and Location fields.");
        }
      });

      // Delete row functionality
      $(document).on('click', '.delete_row', function() {
        $(this).closest('tr').remove();
      });
    });
  </script>

  <!-- Google Maps API -->
  <script>
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.googleapis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
      key: "AIzaSyDCcPel8TpdWZrbZj9IYP5_UOZLc5gPyGU",
      v: "weekly",
    });
  </script>

</body>
</html>
