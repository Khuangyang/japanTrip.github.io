<!DOCTYPE html>
<html>
  <head>
      <base target="_top">
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Visitor Registration Form</title>
      
      <!-- Bootstrap 5.2.3 CSS -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
      
      <!-- jQuery 3.6.0 -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  </head>
  <body>
    <div class="container-fluid p-3">
      <div class="p-3 col-12 col-md-6 col-lg-4">

        <h5 class="card-title text-center mb-4">Visitor Registration Form</h5>
        <form id="myForm" class="was-validated" method="POST">

          <div class="mb-1">
            <label for="exampleDataList" class="form-label p-0">Company Name</label>
            <input class="form-control" list="datalistOptions" id="exampleDataList" placeholder="Type to search..." required>
            <div class="invalid-feedback">Please fill out this field.</div>
            <datalist id="datalistOptions">
              <option value="EBARA Corporate">
              <option value="Elco">
              <option value="Sass">
              <option value="Micron">
              <option value="Be1 Solution">
            </datalist>
          </div>

          <div class="mb-1">
            <div class="form-floating p-0">
              <select class="form-select" id="floatingSelect" aria-label="Floating label select example" required>
                <option value="" selected></option>
                <option value="Meeting">Meeting</option>
                <option value="Delivery / Collection">Delivery / Collection</option>
                <option value="Others">Others</option>
              </select>
              <label for="floatingSelect">Purpose</label>
              <div class="invalid-feedback">Please fill out this field.</div>
            </div>
          </div>

          <div class="mb-1">
            <label for="Name" class="form-label p-0">Name</label>
            <input type="text" class="form-control" id="Name" name="Name" placeholder="Enter your name" required>
            <div class="invalid-feedback">Please fill out this field.</div>
          </div> 

          <div class="mb-1">
            <label for="exampleDataList2" class="form-label p-0">EBARA Host</label>
            <input class="form-control" list="datalistOptions2" id="exampleDataList2" placeholder="Type to search..." required>
            <div class="invalid-feedback">Please fill out this field.</div>
            <datalist id="datalistOptions2">
              <option value="Boven">
              <option value="NG Khuang Yang">
              <option value="Kevin">
              <option value="Susan">
              <option value="Pauline">
            </datalist>
          </div>

          <div class="mb-1">
            <label for="date-input" class="form-label">Date</label>
            <input type="date" class="form-control" required id="date-input" name="date">
            <div id="date-feedback" class="invalid-feedback">
              Please select today's date only.
            </div>
          </div>

          <div class="mb-1">
            <label for="min-time-input" class="form-label">Start Time</label>
            <input type="time" class="form-control" id="min-time-input" required>
            <div id="min-time-feedback" class="invalid-feedback">
              Start time must be before end time.
            </div>
          </div>

          <div class="mb-1">
            <label for="max-time-input" class="form-label">End Time</label>
            <input type="time" class="form-control" id="max-time-input" required>
            <div id="max-time-feedback" class="invalid-feedback">
              End time must be after start time.
            </div>
          </div>

          <div class="mb-1 d-grid">
            <button type="submit" class="btn btn-primary mt-1">Submit Form</button>
          </div>  
        </form>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.getElementById('date-input');
        const dateFeedback = document.getElementById('date-feedback');
        
        // Get today's date in YYYY-MM-DD format
        function getTodayDate() {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        }
        
        const todayDate = getTodayDate();
        
        // Set min and max to today
        dateInput.setAttribute('min', todayDate);
        dateInput.setAttribute('max', todayDate);
        dateInput.value = todayDate;
        
        // Validate date on change
        dateInput.addEventListener('change', function() {
          const selectedDate = this.value;
          this.classList.remove('is-invalid', 'is-valid');
          
          if (selectedDate !== todayDate) {
            this.classList.add('is-invalid');
            if (selectedDate < todayDate) {
              dateFeedback.textContent = 'Past dates are not allowed. Please select today\'s date.';
            } else {
              dateFeedback.textContent = 'Future dates are not allowed. Please select today\'s date.';
            }
          } else {
            this.classList.add('is-valid');
          }
        });
        
        // Time validation
        const minTimeInput = document.getElementById('min-time-input');
        const maxTimeInput = document.getElementById('max-time-input');

        function validateTimes() {
          const minTime = minTimeInput.value;
          const maxTime = maxTimeInput.value;

          minTimeInput.classList.remove('is-invalid', 'is-valid');
          maxTimeInput.classList.remove('is-invalid', 'is-valid');

          if (minTime && maxTime) {
            if (minTime >= maxTime) {
              minTimeInput.classList.add('is-invalid');
              maxTimeInput.classList.add('is-invalid');
            } else {
              minTimeInput.classList.add('is-valid');
              maxTimeInput.classList.add('is-valid');
            }
          }
        }

        minTimeInput.addEventListener('change', validateTimes);
        maxTimeInput.addEventListener('change', validateTimes);
        
        // FORM SUBMISSION
        document.getElementById('myForm').addEventListener('submit', function(e) {
          e.preventDefault();
          
          // Validate date
          const selectedDate = dateInput.value;
          if (selectedDate !== todayDate) {
            dateInput.classList.add('is-invalid');
            if (selectedDate < todayDate) {
              dateFeedback.textContent = 'Past dates are not allowed. Please select today\'s date.';
            } else {
              dateFeedback.textContent = 'Future dates are not allowed. Please select today\'s date.';
            }
            alert('Please select today\'s date only.');
            return false;
          }

          // Validate times
          const minTime = minTimeInput.value;
          const maxTime = maxTimeInput.value;
          
          if (minTime >= maxTime) {
            minTimeInput.classList.add('is-invalid');
            maxTimeInput.classList.add('is-invalid');
            alert('Start time must be before end time!');
            return false;
          }
          
          // Prepare data
          const formData = {
            companyName: document.getElementById('exampleDataList').value,
            purpose: document.getElementById('floatingSelect').value,
            name: document.getElementById('Name').value,
            host: document.getElementById('exampleDataList2').value,
            date: dateInput.value,
            startTime: minTime,
            endTime: maxTime
          };

          // Show loading
          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = 'Submitting...';

          // Submit using google.script.run
          // Submit to Google Apps Script Web App
          const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxkuo4NVsZ7Q_Iw975qy8Cl9aYtb7LPOTwTZhLOfOLqEtt6PY-QKvrik61ORRHw36Xyyw/exec'; // Paste your deployed Web App URL here
          
          fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
          })
          .then(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            alert('Form submitted successfully!');
            document.getElementById('myForm').reset();
            dateInput.value = todayDate;
          })
          .catch(error => {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            alert('An error occurred: ' + error.message);
          });
        });
      });
    </script>
  </body>
</html>
